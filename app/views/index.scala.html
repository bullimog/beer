
@(sequence: model.ReadableSequence, componentCollection: model.ComponentCollection)

@main("Beer Title") {
<div style="width:400px;">
    <fieldset>
        <legend>Thermostats</legend>
        @componentCollection.thermostats.map {thermostat =>
        <fieldset>
            <legend>@thermostat.description</legend>
        <p> <label>Enabled:</label>
            @Html("<input type=\"radio\" name=\"thermostat-enabled"+thermostat.id+"\" id=\"thermostat-true"+thermostat.id + "\" value=\"on\">On "+
                  "<input type=\"radio\" name=\"thermostat-enabled"+thermostat.id+"\" id=\"thermostat-false"+thermostat.id + "\" value=\"off\" checked>Off ")
        </p>
        <p><label>Temperature:</label>
            @Html("<input id=\"thermostat-temperature" + thermostat.id + "\" type=\"number\" min=\"0\" max=\"100\" maxlength=\"3\" value=\"0\">&deg;c")
        </p>
        <p><label>Thermometer:</label>
            @Html("<span id=\"thermostat-thermometer" + thermostat.id + "\"> 0 &deg;c </span>")
        </p>
        <p><label>Heater:</label>
            @Html("<span id=\"thermostat-heater" + thermostat.id + "\"> 0 % </span>")
        </p>
        </fieldset>
        }
    </fieldset>

    <fieldset>
        <legend>Devices</legend>
    @componentCollection.devices.map {device =>
        <p id="device@device.id">
            <label id="deviceDesc@device.id">@device.id: @device.description:</label>
            @{device.deviceType match {
            case 0 => Html("<span id=\"device-val" + device.id + "\"> 0 seconds </span>")
            case 1 => Html("<span id=\"device-val" + device.id + "\"> 0 &deg;c </span>")
            case 2 => Html("<input id=\"device-val" + device.id + "\" type=\"number\" min=\"0\" max=\"100\" maxlength=\"3\" value=\"0\">%")
            case 3 => Html("<span>Button</span>")
            case 4 => Html("<input type=\"radio\" name=\"device-name"+device.id+"\" id=\"device-true"+device.id + "\" value=\"true\">On "+
                           "<input type=\"radio\" name=\"device-name"+device.id+"\" id=\"device-false"+device.id + "\" value=\"false\"  checked>Off ")
            case _ => "Not implemented"
            }}
        </p>
        }

    </fieldset>


    <fieldset>
        <legend>Program</legend>
        <table class="program">
            <tr><th>#</th><th>Component</th><th>Action</th></tr>
            @sequence.friendlySteps.map {step =>
            <tr id="step@step.stepId">
                <td>@step.stepId</td>
                <td id="stepDevice@step.stepId">@step.deviceDesc</td>
                <td id="stepDesc@step.stepId">@step.eventDesc @step.temperature @step.duration</td>
            </tr>
            }
        </table>
    </fieldset>


    <p class="form-field">
        <button id="startButton" onclick="startSequencer()" class="button" value="Next">@Messages("Start")</button>
        <button id="stopButton" onclick="stopSequencer()" class="button" value="Next">@Messages("Abort")</button>
    </p>
</div>
}

<script type="text/javascript">

   <!--$(".program").children().css({"color": "red", "border": "2px solid red"});-->


  function highlightSteps(current){
    if(current > 0) {
      var steps = $(".program").children().children();
      for(var i=1; i<current; i++){
        $("#"+steps[i].id).removeClass("to-run");
        $("#"+steps[i].id).removeClass("running");
        $("#"+steps[i].id).addClass("ran");
      }

      $("#step"+current).removeClass("to-run");
      $("#step"+current).addClass("running");
      $("#step"+current).removeClass("ran");

      for(var i=current+1; i<steps.length; i++){
         $("#"+steps[i].id).addClass("to-run");
         $("#"+steps[i].id).removeClass("running");
         $("#"+steps[i].id).removeClass("ran");
      }
    }
  }

  function highlightStartStopButtons(running){
    if(running==true){
       $("#startButton").addClass("btn-disable")
       $("#startButton").removeClass("btn-enable")
       $("#stopButton").addClass("btn-enable")
       $("#stopButton").removeClass("btn-disable")
    }
    else{
       $("#startButton").addClass("btn-enable")
       $("#startButton").removeClass("btn-disable")
       $("#stopButton").addClass("btn-disable")
       $("#stopButton").removeClass("btn-enable")
    }
  }

  function updateDevices(ss){
     for(i=0; i<ss.componentStatuses.length; i++){
        var compId = ss.componentStatuses[i].componentId
        var compType = ss.componentStatuses[i].componentType
        var compValue = ss.componentStatuses[i].componentValue
        //console.debug("comp: "+ compId + " - "  + compType +" - " + compValue);

        switch(compType){
          case 0: {$("#device-val"+compId).text(formatTimer(compValue)); break;} //TIMER
          case 1: {$("#device-val"+compId).text(compValue+" \xB0c"); break;}     //ANALOGUE_IN / Thermometer
          case 2: {$("#device-val"+compId).val(compValue); break;}               //ANALOGUE OUT / Heater
          case 4: {                                                              //DIGITAL_OUT
            if(compValue == "true") $("#device-true"+compId).prop("checked", true)
            else $("#device-false"+compId).prop("checked", true);
            break;
          }
        }
     }
  }

  function formatTimer(totalSeconds){
    hours = Math.floor(totalSeconds / 3600);
    totalSeconds %= 3600;
    mins= Math.floor(totalSeconds / 60);
    secs = totalSeconds % 60;
    return (""+padZero(hours)+":"+padZero(mins)+":"+padZero(secs))
  }

  function padZero(num){
    if(num<10) return "0"+num
    else return num
  }

  function updateThermostats(ss){
    for(i=0; i<ss.thermostatStatuses.length; i++){
       var thermostatId = ss.thermostatStatuses[i].componentId
       var thermostatEnabled = ss.thermostatStatuses[i].enabled
       var thermostatTemp = ss.thermostatStatuses[i].temperature
       var thermometerTemp = ss.thermostatStatuses[i].thermometerStatus.componentValue
       var heaterPower = ss.thermostatStatuses[i].heaterStatus.componentValue

       if(thermostatEnabled) $("#thermostat-true"+thermostatId).prop("checked", true)
            else $("#thermostat-false"+thermostatId).prop("checked", true);

       $("#thermostat-temperature"+thermostatId).val(thermostatTemp);
       $("#thermostat-thermometer"+thermostatId).text(thermometerTemp+" \xB0c");
       $("#thermostat-heater"+thermostatId).val(heaterPower);
    }
  }

  function startSequencer(){jsRoutes.controllers.Application.startSequencer(null).ajax();};
  function stopSequencer(){jsRoutes.controllers.Application.stopSequencer(null).ajax();};

$(function() {sequencerStatusCall();});



var sequencerStatusCall = function() {
    var ajaxCallBack = {
        success : onSuccess,
        error : onError
    }
    jsRoutes.controllers.Application.sequencerStatus().ajax(ajaxCallBack);

    setTimeout(sequencerStatusCall, 1000);
};

var  onSuccess = function(strSequenceStatus) {
    var ss = JSON.parse(strSequenceStatus);
    highlightStartStopButtons(ss.running)
    highlightSteps(ss.currentStep)
    updateDevices(ss)
    updateThermostats(ss)
}

var onError = function(error) {
    console.debug("Error in ajax Call");
    console.debug(error);
}


</script>
